<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LABSE - Gesti√≥n Cloud</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: 'Segoe UI', system-ui, sans-serif; overflow: hidden; }
        .oculto { display: none !important; }
        .visible { display: flex !important; }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        .loading-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: flex; justify-content: center; align-items: center; z-index: 100; backdrop-filter: blur(2px); }
        .card-hover:hover { transform: translateY(-5px); box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1); border-color: #3b82f6; }
        .scroll-fino::-webkit-scrollbar { width: 6px; }
        .scroll-fino::-webkit-scrollbar-track { background: #1e293b; }
        .scroll-fino::-webkit-scrollbar-thumb { background: #475569; border-radius: 10px; }
    </style>
</head>
<body class="h-screen w-screen flex flex-col bg-slate-950">

    <div id="loader" class="loading-overlay">
        <div class="text-center">
            <i class="fas fa-circle-notch fa-spin text-4xl text-blue-500 mb-4"></i>
            <p class="text-white font-bold">Conectando a LABSE Cloud...</p>
        </div>
    </div>

    <div id="vista-pass" class="oculto fixed inset-0 z-50 w-full h-full bg-slate-950 items-center justify-center flex-col fade-in p-6">
        <div class="bg-slate-900 p-10 rounded-3xl border border-slate-800 shadow-2xl w-full max-w-md text-center">
            <div class="mb-8"><h1 class="text-4xl font-black text-white tracking-tighter">ACCESO LABSE</h1><p class="text-emerald-400 text-xs font-bold mt-2">‚óè ONLINE</p></div>
            <form onsubmit="verificarPassword(event)" class="flex flex-col gap-4">
                <input type="password" id="sys-pass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" class="w-full bg-slate-950 text-white border border-slate-700 rounded-xl py-3 text-center outline-none transition text-lg tracking-widest focus:border-blue-500">
                <button type="submit" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-xl shadow-lg transition transform active:scale-95">INICIAR</button>
            </form>
        </div>
    </div>

    <div id="vista-roles" class="oculto fixed inset-0 z-40 w-full h-full bg-slate-950 items-center justify-center flex-col fade-in p-6">
        <div class="text-center mb-12"><h2 class="text-3xl font-bold text-white">Selecciona Perfil</h2></div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 max-w-4xl w-full">
            <button onclick="seleccionarRol('admin')" class="group bg-slate-900 border border-slate-800 p-10 rounded-3xl hover:border-blue-500/50 flex flex-col items-center gap-4 text-center cursor-pointer shadow-xl transition-all">
                <i class="fas fa-user-cog text-4xl text-blue-400"></i><div><h3 class="text-2xl font-bold text-white">Administraci√≥n</h3><p class="text-slate-400 text-sm">Gesti√≥n total</p></div>
            </button>
            <button onclick="seleccionarRol('visita')" class="group bg-slate-900 border border-slate-800 p-10 rounded-3xl hover:border-emerald-500/50 flex flex-col items-center gap-4 text-center cursor-pointer shadow-xl transition-all">
                <i class="fas fa-eye text-4xl text-emerald-400"></i><div><h3 class="text-2xl font-bold text-white">Consulta</h3><p class="text-slate-400 text-sm">Solo lectura</p></div>
            </button>
        </div>
        <button onclick="volverAlBloqueo()" class="mt-12 text-slate-500 hover:text-white text-sm transition"><i class="fas fa-arrow-left"></i> Volver</button>
    </div>

    <div id="vista-dashboard" class="oculto w-full h-full flex-col relative bg-slate-950 fade-in">
        <header class="w-full p-6 flex justify-between items-center bg-transparent relative z-10">
            <div><div class="text-2xl font-black text-slate-100">LABSE <span class="text-blue-500">.CLOUD</span></div></div>
            <button onclick="volverARoles()" class="text-slate-500 hover:text-white transition px-3 py-2 text-sm font-bold">SALIR</button>
        </header>
        <div class="flex-1 flex flex-col items-center justify-center p-6 -mt-10">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 w-full max-w-6xl px-4">
                <div onclick="abrirInventario('Insumos')" class="bg-slate-900 rounded-3xl p-8 cursor-pointer border border-slate-800 hover:border-blue-500/50 card-hover transition-all">
                    <i class="fas fa-boxes text-4xl text-blue-400 mb-4"></i><h3 class="text-2xl font-bold text-white">Insumos</h3><p class="text-slate-400 text-sm">Consumibles</p>
                </div>
                <div onclick="abrirInventario('Herramientas')" class="bg-slate-900 rounded-3xl p-8 cursor-pointer border border-slate-800 hover:border-indigo-500/50 card-hover transition-all">
                    <i class="fas fa-tools text-4xl text-indigo-400 mb-4"></i><h3 class="text-2xl font-bold text-white">Herramientas</h3><p class="text-slate-400 text-sm">Activos fijos</p>
                </div>
                <div onclick="abrirInstrumentacion()" class="bg-slate-900 rounded-3xl p-8 cursor-pointer border border-slate-800 hover:border-purple-500/50 card-hover transition-all">
                    <i class="fas fa-tasks text-4xl text-purple-400 mb-4"></i><h3 class="text-2xl font-bold text-white">Instrumentaci√≥n</h3><p class="text-slate-400 text-sm">Planificaci√≥n de Trabajos</p>
                </div>
            </div>
            <button onclick="generarOrden()" class="mt-12 px-8 py-4 rounded-2xl bg-slate-800 text-white font-bold hover:bg-slate-700 border border-slate-700 transition w-full max-w-lg">GENERAR ORDEN DE COMPRA</button>
            <div class="absolute bottom-4 text-xs text-emerald-500 flex items-center gap-2"><div class="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></div> Conectado a Firebase</div>
        </div>
    </div>

    <div id="vista-tabla" class="oculto w-full h-full flex-col bg-slate-950 fade-in">
        <div class="px-6 py-4 border-b border-slate-800 flex justify-between items-center bg-slate-900/50 backdrop-blur-md sticky top-0 z-20">
            <div class="flex items-center gap-4">
                <button onclick="volverAlDashboard()" class="w-8 h-8 rounded-full bg-slate-800 flex items-center justify-center text-slate-400 hover:text-white transition"><i class="fas fa-arrow-left"></i></button>
                <h2 id="titulo-cat" class="text-xl font-bold text-white">Inventario</h2>
            </div>
            <button id="btn-nuevo-item" onclick="mostrarModalNuevo()" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg font-bold text-sm shadow-lg transition">+ Nuevo</button>
        </div>
        <div class="flex-1 overflow-auto p-4 md:p-8">
            <div class="bg-slate-900 rounded-2xl border border-slate-800 shadow-2xl overflow-hidden">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-slate-950 text-slate-400 uppercase text-xs font-semibold">
                        <tr><th class="p-5 border-b border-slate-800">C√≥d</th><th class="p-5 border-b border-slate-800">Producto</th><th class="p-5 border-b border-slate-800 hidden md:table-cell">Prov</th><th class="p-5 border-b border-slate-800 text-center">Stock</th><th class="p-5 border-b border-slate-800 text-center">Estado</th><th id="col-accion" class="p-5 border-b border-slate-800 text-right"></th></tr>
                    </thead>
                    <tbody id="tabla-body" class="divide-y divide-slate-800 text-sm text-slate-300"></tbody>
                </table>
                <div id="vacio-msg" class="text-center py-20 hidden flex-col items-center"><div class="w-16 h-16 bg-slate-800 rounded-full flex items-center justify-center text-3xl mb-4">üì≠</div><p class="text-slate-500">Sin productos.</p></div>
            </div>
        </div>
    </div>

    <div id="vista-instrumentacion" class="oculto w-full h-full flex-col relative bg-slate-950 fade-in">
        <div class="px-6 py-4 border-b border-slate-800 flex justify-between items-center bg-slate-900/50 backdrop-blur-md sticky top-0 z-20">
            <div class="flex items-center gap-4">
                <button onclick="volverAlDashboard()" class="w-8 h-8 rounded-full bg-slate-800 flex items-center justify-center text-slate-400 hover:text-white transition"><i class="fas fa-arrow-left"></i></button>
                <h2 class="text-xl font-bold text-white text-purple-400">Trabajos de Instrumentaci√≥n</h2>
            </div>
            <button id="btn-nueva-tarea" onclick="agregarTarea()" class="bg-purple-600 hover:bg-purple-500 text-white px-4 py-2 rounded-lg font-bold text-sm transition hidden">+ Nueva Tarea</button>
        </div>
        <div class="flex-1 overflow-auto p-8 flex flex-col items-center">
            <div id="lista-tareas" class="grid grid-cols-1 gap-4 w-full max-w-4xl"></div>
        </div>
    </div>

    <div id="vista-consulta" class="oculto w-full h-full flex-col relative bg-slate-950 fade-in">
        <header class="w-full p-6 flex justify-between items-center bg-slate-900 border-b border-slate-800 sticky top-0 z-20">
            <div><div class="text-2xl font-black text-slate-100">LABSE <span class="text-emerald-500">.CLOUD</span></div><div class="text-xs text-emerald-500 font-bold uppercase tracking-widest mt-1">CONSULTAS</div></div>
            <button onclick="volverARoles()" class="text-slate-500 hover:text-white transition px-3 py-2 text-sm font-bold">SALIR</button>
        </header>
        <div class="flex-1 overflow-hidden flex flex-col max-w-6xl mx-auto w-full p-6">
            <div class="flex flex-col md:flex-row gap-4 mb-6">
                <input type="text" id="buscador-global" onkeyup="buscarProducto()" placeholder="Buscar..." class="flex-1 bg-slate-900 border border-slate-700 text-white rounded-xl py-4 px-6 outline-none text-lg shadow-lg">
                <div class="flex gap-2">
                    <button onclick="generarReporteGeneral()" class="bg-slate-800 hover:bg-slate-700 text-white px-4 rounded-xl text-xs font-bold border border-slate-700">REPORTE</button>
                    <button onclick="generarReporteFaltantes()" class="bg-slate-800 hover:bg-slate-700 text-red-400 px-4 rounded-xl text-xs font-bold border border-slate-700">FALTANTES</button>
                    <button onclick="generarOrden()" class="bg-slate-800 hover:bg-slate-700 text-purple-400 px-4 rounded-xl text-xs font-bold border border-slate-700">SOLICITAR</button>
                </div>
            </div>
            <div class="flex-1 bg-slate-900 rounded-2xl border border-slate-800 shadow-2xl overflow-auto p-4">
                <table class="w-full text-left text-sm text-slate-300"><tbody id="tabla-consulta" class="divide-y divide-slate-800"></tbody></table>
            </div>
        </div>
    </div>

    <div id="modal-trabajo" class="oculto fixed inset-0 z-50 bg-black/90 backdrop-blur-sm items-center justify-center p-4 fade-in overflow-y-auto">
        <div class="bg-slate-900 border border-slate-800 rounded-2xl w-full max-w-4xl shadow-2xl my-auto relative flex flex-col h-[90vh]">
            <div class="flex justify-between items-center p-6 border-b border-slate-800">
                <div><h3 id="mt-titulo" class="text-2xl font-bold text-white">Trabajo</h3><p class="text-slate-400 text-sm">Planificaci√≥n</p></div>
                <button onclick="cerrarModalTrabajo()" class="text-slate-500 hover:text-white text-2xl"><i class="fas fa-times"></i></button>
            </div>
            <div class="flex-1 overflow-auto p-6 grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="flex flex-col h-full">
                    <div class="flex justify-between items-center mb-4"><h4 class="text-blue-400 font-bold text-xs uppercase">Materiales (x Operario)</h4><button onclick="agregarMaterialATrabajo()" class="text-xs bg-slate-800 px-3 py-1 rounded text-white border border-slate-700 hover:bg-slate-700" id="btn-add-mat">+ Item</button></div>
                    <div class="flex-1 bg-slate-950 rounded-xl border border-slate-800 overflow-hidden"><table class="w-full text-left text-sm"><thead class="bg-slate-900 text-slate-400 text-xs uppercase"><tr><th class="p-3">Item</th><th class="p-3 text-center">Cant.</th><th class="p-3 text-right"></th></tr></thead><tbody id="mt-lista-materiales" class="divide-y divide-slate-800"></tbody></table><div id="mt-vacio" class="p-8 text-center text-slate-500 text-xs">Sin materiales.</div></div>
                </div>
                <div class="bg-slate-800/30 p-6 rounded-xl border border-slate-700/50 flex flex-col">
                    <h4 class="text-emerald-400 font-bold text-xs uppercase mb-4">Simular Ejecuci√≥n</h4>
                    <div class="mb-6"><label class="block text-slate-300 text-sm mb-2">Operarios:</label><div class="flex gap-2"><input type="number" id="mt-operarios" value="1" min="1" class="bg-slate-900 border border-slate-600 text-white rounded px-4 py-2 w-24 text-center font-bold outline-none" onchange="calcularDisponibilidad()"><button onclick="calcularDisponibilidad()" class="bg-emerald-600 hover:bg-emerald-500 text-white px-4 py-2 rounded font-bold text-sm flex-1">Verificar Stock</button></div></div>
                    <div id="mt-resultado" class="flex-1 overflow-auto space-y-3"><div class="text-center text-slate-500 text-sm mt-10">Define operarios para calcular.</div></div>
                    <button onclick="imprimirPlan()" class="mt-4 w-full bg-slate-700 hover:bg-slate-600 text-white py-3 rounded-lg font-bold text-xs">IMPRIMIR REPORTE</button>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-buscador" class="oculto fixed inset-0 z-[60] bg-black/80 items-center justify-center p-4 fade-in">
        <div class="bg-slate-900 border border-slate-800 rounded-xl w-full max-w-md p-6">
            <h3 class="text-white font-bold mb-4">Seleccionar Producto</h3>
            <input type="text" id="mb-input" placeholder="Buscar..." class="w-full bg-slate-950 border border-slate-700 text-white rounded p-2 mb-4 outline-none focus:border-blue-500" onkeyup="filtrarBuscadorModal()">
            <div class="h-64 overflow-auto bg-slate-950 rounded border border-slate-800 p-1" id="mb-lista"></div>
            <button onclick="cerrarBuscador()" class="mt-4 w-full bg-slate-800 hover:bg-slate-700 text-white py-2 rounded font-bold text-sm">Cancelar</button>
        </div>
    </div>

    <div id="modal" class="oculto fixed inset-0 z-50 bg-black/80 backdrop-blur-sm items-center justify-center p-4 fade-in overflow-y-auto">
        <div class="bg-slate-900 border border-slate-800 rounded-2xl w-full max-w-2xl shadow-2xl my-auto relative p-6">
            <div class="flex justify-between mb-4"><h3 id="modal-titulo" class="text-xl font-bold text-white">Producto</h3><button onclick="cerrarModal()" class="text-slate-500 hover:text-white">‚úï</button></div>
            <form onsubmit="guardarProducto(event)">
                <input type="text" id="m-resp" placeholder="Responsable *" class="w-full bg-slate-950 text-white border border-slate-700 rounded p-3 mb-4 focus:border-blue-500 outline-none" required>
                <div class="grid grid-cols-4 gap-4 mb-4"><input type="text" id="m-cod" placeholder="C√≥digo" required class="col-span-1 bg-slate-800 text-white border-slate-700 rounded p-2"><input type="text" id="m-nombre" placeholder="Nombre" required class="col-span-3 bg-slate-800 text-white border-slate-700 rounded p-2"></div>
                <div class="grid grid-cols-3 gap-4 mb-4"><input type="number" id="m-cant" placeholder="Stock" required class="bg-slate-800 text-white border-slate-700 rounded p-2"><input type="number" id="m-min" placeholder="M√≠nimo" required class="bg-slate-800 text-white border-slate-700 rounded p-2"><input type="text" id="m-uni" placeholder="Unidad" class="bg-slate-800 text-white border-slate-700 rounded p-2"></div>
                <div class="bg-slate-950/50 p-4 rounded border border-slate-800 mb-4"><div class="grid grid-cols-2 gap-2 mb-2"><input id="p-nombre" placeholder="Prov. Nombre" class="bg-slate-900 text-white border-slate-700 rounded p-2"><input id="p-tel" placeholder="Tel√©fono" class="bg-slate-900 text-white border-slate-700 rounded p-2"></div><button type="button" onclick="agregarProveedorTemporal()" class="text-xs text-emerald-500">+ Agregar Prov</button><ul id="lista-proveedores-temp" class="mt-2 text-xs text-slate-400"></ul></div>
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-500 text-white py-2 rounded font-bold">Guardar</button>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // TUS CREDENCIALES
        const firebaseConfig = {
            apiKey: "AIzaSyDGdmmkyzzxtkQTUK-siCPxJOgGN3N4isQ",
            authDomain: "sistema-labse.firebaseapp.com",
            projectId: "sistema-labse",
            storageBucket: "sistema-labse.firebasestorage.app",
            messagingSenderId: "1025355132653",
            appId: "1:1025355132653:web:60faecfc02ea8ed97d66e4",
            measurementId: "G-BEPZRJ8EJ1"
        };

        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const productosCol = collection(db, 'productos');
        const tareasCol = collection(db, 'tareas');

        // Variables Globales
        let datos = [];
        let tareas = [];
        let catActual = '';
        let proveedoresTemporales = [];
        let esAdmin = false;
        let tareaActual = null;
        let editandoId = null; // En firebase ser√° el ID del documento
        let ultimoResponsable = '';

        // ESCUCHAR CAMBIOS EN TIEMPO REAL (Productos)
        onSnapshot(productosCol, (snapshot) => {
            datos = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
            document.getElementById('loader').classList.add('oculto');
            if(document.getElementById('vista-pass').classList.contains('oculto') && !esAdmin) {
                 // Si ya pas√≥ el login, refrescar
            }
            if(catActual) renderTabla();
            if(document.getElementById('vista-consulta').classList.contains('visible')) buscarProducto();
        }, (error) => {
            console.error("Error BD:", error);
            alert("Error conectando a la base de datos.");
        });

        // ESCUCHAR CAMBIOS EN TIEMPO REAL (Tareas)
        onSnapshot(tareasCol, (snapshot) => {
            tareas = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
            if(document.getElementById('vista-instrumentacion').classList.contains('visible')) renderTareas();
            // Actualizar modal si est√° abierto
            if(tareaActual) {
                const tActualizada = tareas.find(t => t.id === tareaActual.id);
                if(tActualizada) {
                    tareaActual = tActualizada;
                    renderMaterialesTarea();
                }
            }
        });

        // --- FUNCIONES EXPORTADAS A WINDOW (Para que el HTML las vea) ---
        window.irA = (id) => {
            document.querySelectorAll('body > div').forEach(el => {
                if(el.id.startsWith('vista-')) el.classList.add('oculto');
                if(el.id.startsWith('vista-')) el.classList.remove('visible');
            });
            const d = document.getElementById(id);
            if(d) { d.classList.remove('oculto'); d.classList.add('visible'); }
        };

        window.verificarPassword = (e) => { e.preventDefault(); if(document.getElementById('sys-pass').value.trim() === 'labse') window.irA('vista-roles'); else alert('Incorrecto'); };

        window.seleccionarRol = (rol) => {
            esAdmin = (rol === 'admin');
            const btnsAdmin = [document.getElementById('btn-nuevo-item'), document.getElementById('col-accion'), document.getElementById('btn-nueva-tarea')];
            btnsAdmin.forEach(b => { if(b) b.classList.toggle('hidden', !esAdmin); });
            const btnAddMat = document.getElementById('btn-add-mat');
            if(btnAddMat) btnAddMat.style.display = esAdmin ? 'block' : 'none';
            if(esAdmin) window.irA('vista-dashboard'); else { window.irA('vista-consulta'); window.buscarProducto(); }
        };

        window.volverAlBloqueo = () => { document.getElementById('sys-pass').value=''; window.irA('vista-pass'); };
        window.volverARoles = () => { window.irA('vista-roles'); };
        window.volverAlDashboard = () => { window.irA('vista-dashboard'); };

        window.abrirInventario = (cat) => { catActual = cat; document.getElementById('titulo-cat').innerText = cat; window.renderTabla(); window.irA('vista-tabla'); };

        window.renderTabla = () => {
            const tbody = document.getElementById('tabla-body');
            const vacio = document.getElementById('vacio-msg');
            tbody.innerHTML = '';
            
            const filtrados = datos.filter(d => d.cat === catActual).sort((a, b) => {
                const na = parseInt(a.cod), nb = parseInt(b.cod);
                if(!isNaN(na) && !isNaN(nb)) return na - nb;
                return String(a.cod).localeCompare(String(b.cod));
            });

            if(filtrados.length === 0) { vacio.classList.remove('hidden'); vacio.classList.add('flex'); } 
            else { vacio.classList.add('hidden'); vacio.classList.remove('flex'); }

            filtrados.forEach(item => {
                const critico = parseInt(item.cant) < parseInt(item.min);
                let prov = item.proveedores && item.proveedores.length ? item.proveedores[0].nombre : '-';
                let tr = document.createElement('tr');
                tr.className = "hover:bg-slate-900/50 border-b border-slate-800 text-slate-300";
                
                let btns = '';
                // OJO: Pasamos el ID como string entre comillas
                if(esAdmin) btns = `<div class="flex justify-end gap-2"><button onclick="editar('${item.id}')" class="text-blue-400 hover:text-white">‚úèÔ∏è</button><button onclick="borrar('${item.id}')" class="text-red-400 hover:text-white">üóëÔ∏è</button></div>`;

                tr.innerHTML = `<td class="p-4 font-mono text-blue-400 font-bold">${item.cod}</td><td class="p-4">${item.nom}</td><td class="p-4 text-xs hidden md:table-cell">${prov}</td><td class="p-4 text-center font-bold ${critico?'text-red-400':'text-emerald-400'}">${item.cant}</td><td class="p-4 text-center"><span class="text-[10px] px-2 py-1 rounded border ${critico?'border-red-500/50 text-red-400':'border-emerald-500/50 text-emerald-400'}">${critico?'BAJO':'OK'}</span></td><td class="p-4 text-right">${btns}</td>`;
                tbody.appendChild(tr);
            });
        };

        window.abrirInstrumentacion = () => { window.irA('vista-instrumentacion'); window.renderTareas(); };
        window.renderTareas = () => {
            const c = document.getElementById('lista-tareas'); c.innerHTML = '';
            tareas.forEach(t => {
                let div = document.createElement('div');
                div.className = "bg-slate-900 p-5 rounded-xl border border-slate-800 hover:border-purple-500 cursor-pointer flex justify-between items-center group transition";
                div.onclick = (e) => { if(!e.target.closest('button')) window.abrirDetalleTrabajo(t.id); };
                let btns = esAdmin ? `<div class="flex gap-2"><button onclick="editNomTarea('${t.id}', event)" class="p-2 hover:text-blue-400">‚úèÔ∏è</button><button onclick="delTarea('${t.id}', event)" class="p-2 hover:text-red-400">üóëÔ∏è</button></div>` : '<span class="text-slate-600">></span>';
                div.innerHTML = `<div class="flex items-center gap-4"><span class="text-slate-200 font-bold">${t.nombre}</span></div>${btns}`;
                c.appendChild(div);
            });
        };

        window.agregarTarea = async () => { const n = prompt("Nombre Tarea:"); if(n) { await addDoc(tareasCol, {nombre: n, materiales: []}); } };
        window.editNomTarea = async (id, e) => { e.stopPropagation(); const t = tareas.find(x=>x.id===id); const n = prompt("Nuevo nombre:", t.nombre); if(n) { await updateDoc(doc(db, 'tareas', id), {nombre: n}); } };
        window.delTarea = async (id, e) => { e.stopPropagation(); if(confirm("¬øBorrar?")) { await deleteDoc(doc(db, 'tareas', id)); } };

        window.abrirDetalleTrabajo = (id) => {
            tareaActual = tareas.find(t => t.id === id);
            document.getElementById('mt-titulo').innerText = tareaActual.nombre;
            document.getElementById('modal-trabajo').classList.remove('oculto'); document.getElementById('modal-trabajo').classList.add('visible');
            window.renderMaterialesTarea();
            document.getElementById('mt-resultado').innerHTML = '<div class="text-center text-slate-500 text-sm mt-10">Define operarios.</div>';
        };
        window.cerrarModalTrabajo = () => { document.getElementById('modal-trabajo').classList.remove('visible'); document.getElementById('modal-trabajo').classList.add('oculto'); };
        
        window.renderMaterialesTarea = () => {
            const tb = document.getElementById('mt-lista-materiales'); tb.innerHTML = '';
            document.getElementById('mt-vacio').style.display = tareaActual.materiales.length ? 'none' : 'block';
            tareaActual.materiales.forEach((m, idx) => {
                const item = datos.find(d => d.cod === m.cod);
                let tr = document.createElement('tr'); tr.className = "border-b border-slate-800 text-slate-300";
                let btn = esAdmin ? `<button onclick="delMatTarea(${idx})" class="text-red-500 hover:text-white">‚úï</button>` : '';
                tr.innerHTML = `<td class="p-3"><div class="font-bold text-white">${m.cod}</div><div class="text-xs text-slate-500">${item?item.nom:'Item Borrado'}</div></td><td class="p-3 text-center">${m.cant}</td><td class="p-3 text-right">${btn}</td>`;
                tb.appendChild(tr);
            });
        };

        window.agregarMaterialATrabajo = () => { 
            if(datos.length === 0) return alert('¬°Inventario vac√≠o! Carga productos primero.');
            document.getElementById('modal-buscador').classList.remove('oculto'); 
            document.getElementById('modal-buscador').classList.add('visible'); 
            document.getElementById('mb-input').value=''; 
            window.filtrarBuscadorModal(); 
        };
        window.cerrarBuscador = () => { 
            document.getElementById('modal-buscador').classList.remove('visible'); 
            document.getElementById('modal-buscador').classList.add('oculto'); 
        };
        window.filtrarBuscadorModal = () => {
            const txt = document.getElementById('mb-input').value.toLowerCase();
            const l = document.getElementById('mb-lista'); l.innerHTML = '';
            const matches = datos.filter(d => {
                const n = d.nom ? d.nom.toLowerCase() : "";
                const c = d.cod ? d.cod.toLowerCase() : "";
                return n.includes(txt) || c.includes(txt);
            });
            if(matches.length === 0) {
                l.innerHTML = '<div class="p-4 text-slate-500 text-center text-sm">No se encontraron productos.</div>';
                return;
            }
            matches.forEach(d => {
                let div = document.createElement('div'); 
                div.className = "p-3 border-b border-slate-800 hover:bg-slate-800 cursor-pointer flex justify-between items-center group";
                div.onclick = async () => {
                    const c = prompt(`Cantidad de "${d.nom}" necesaria POR OPERARIO:`);
                    if(c && !isNaN(c)) { 
                        const newMats = [...tareaActual.materiales, {cod: d.cod, cant: parseInt(c)}];
                        await updateDoc(doc(db, 'tareas', tareaActual.id), {materiales: newMats});
                        window.cerrarBuscador(); 
                    }
                };
                div.innerHTML = `<div><span class="text-sm text-slate-300 font-bold block">${d.nom}</span><span class="text-xs text-slate-500">${d.cat} | Stock: ${d.cant}</span></div><span class="text-xs bg-slate-700 px-2 py-1 rounded text-white group-hover:bg-blue-600 transition">Agregar</span>`;
                l.appendChild(div);
            });
        };
        window.delMatTarea = async (idx) => { 
            if(confirm("¬øQuitar?")) { 
                const newMats = [...tareaActual.materiales];
                newMats.splice(idx, 1);
                await updateDoc(doc(db, 'tareas', tareaActual.id), {materiales: newMats});
            } 
        };

        window.calcularDisponibilidad = () => {
            const ops = parseInt(document.getElementById('mt-operarios').value) || 1;
            const res = document.getElementById('mt-resultado'); res.innerHTML = '';
            if(!tareaActual.materiales.length) { res.innerHTML = '<div class="text-yellow-500 text-center">Lista vac√≠a</div>'; return; }
            let ok = true;
            tareaActual.materiales.forEach(m => {
                const item = datos.find(d => d.cod === m.cod);
                const nec = m.cant * ops;
                const stock = item ? parseInt(item.cant) : 0;
                const falta = nec - stock;
                if(falta > 0) ok = false;
                let div = document.createElement('div'); div.className = `p-3 rounded border flex justify-between text-sm ${falta>0?'bg-red-500/10 border-red-500/30':'bg-emerald-500/10 border-emerald-500/30'}`;
                div.innerHTML = `<div><div class="font-bold text-white">${item?item.nom:m.cod}</div><div class="text-xs text-slate-400">Nec: ${nec} | Stock: ${stock}</div></div><div class="text-right font-bold ${falta>0?'text-red-400':'text-emerald-400'}">${falta>0?'FALTA '+falta:'OK'}</div>`;
                res.appendChild(div);
            });
            res.prepend(document.createElement('div')); 
            res.firstChild.className = `text-center p-2 rounded font-bold text-sm mb-4 ${ok?'bg-emerald-600 text-white':'bg-red-600 text-white'}`;
            res.firstChild.innerText = ok ? "‚úÖ STOCK SUFICIENTE" : "‚ö†Ô∏è STOCK INSUFICIENTE";
        };

        // CRUD FIREBASE
        window.mostrarModalNuevo = () => { 
            if(!catActual) return alert('Por favor, selecciona Insumos o Herramientas primero.');
            editandoId=null; 
            document.getElementById('modal-titulo').innerText='Nuevo ' + (catActual==='Insumos'?'Insumo':'Herramienta');
            window.limpiarForm(); 
            if(ultimoResponsable) document.getElementById('m-resp').value = ultimoResponsable; 
            document.getElementById('modal').classList.remove('oculto'); 
            document.getElementById('modal').classList.add('visible'); 
        };

        window.editar = (id) => { 
            const d=datos.find(x=>x.id===id); if(!d)return; 
            editandoId=id; 
            document.getElementById('modal-titulo').innerText='Editar'; 
            document.getElementById('m-resp').value=d.resp||''; 
            document.getElementById('m-cod').value=d.cod; 
            document.getElementById('m-nombre').value=d.nom; 
            document.getElementById('m-cant').value=d.cant; 
            document.getElementById('m-min').value=d.min; 
            document.getElementById('m-uni').value=d.uni; 
            proveedoresTemporales=d.proveedores?[...d.proveedores]:[]; 
            window.renderProveedoresTemp(); 
            document.getElementById('modal').classList.remove('oculto'); 
            document.getElementById('modal').classList.add('visible'); 
        };

        window.cerrarModal = () => { document.getElementById('modal').classList.remove('visible'); document.getElementById('modal').classList.add('oculto'); };
        window.limpiarForm = () => { ['m-cod','m-nombre','m-cant','m-min','m-uni'].forEach(id=>document.getElementById(id).value=''); proveedoresTemporales=[]; window.renderProveedoresTemp(); };
        window.agregarProveedorTemporal = () => { const n=document.getElementById('p-nombre').value; if(n){ proveedoresTemporales.push({nombre:n, tel:document.getElementById('p-tel').value}); document.getElementById('p-nombre').value=''; document.getElementById('p-tel').value=''; window.renderProveedoresTemp(); } };
        window.renderProveedoresTemp = () => { const l=document.getElementById('lista-proveedores-temp'); l.innerHTML=''; proveedoresTemporales.forEach((p,i)=>{ l.innerHTML+=`<li>${p.nombre} <button onclick="proveedoresTemporales.splice(${i},1);window.renderProveedoresTemp()" class="text-red-500">x</button></li>`; }); };
        
        window.guardarProducto = async (e) => { 
            e.preventDefault(); 
            const r=document.getElementById('m-resp').value; 
            if(!r) return alert('Falta Responsable'); 
            ultimoResponsable=r; 
            const c=document.getElementById('m-cod').value; 
            
            // Validar C√≥digo duplicado (excluyendo el que editamos)
            if(datos.some(d=>d.cod===c && d.id!==editandoId)) return alert('C√≥digo existe'); 
            
            if(document.getElementById('p-nombre').value) window.agregarProveedorTemporal(); 
            if(!catActual) return alert('Error categor√≠a');

            const obj = {
                resp:r, 
                cod:c, 
                nom:document.getElementById('m-nombre').value, 
                cant:parseInt(document.getElementById('m-cant').value), 
                min:parseInt(document.getElementById('m-min').value), 
                uni:document.getElementById('m-uni').value, 
                proveedores:proveedoresTemporales, 
                cat:catActual
            }; 
            
            try {
                if(editandoId){ 
                    await updateDoc(doc(db, 'productos', editandoId), obj);
                } else { 
                    await addDoc(productosCol, obj);
                }
                window.cerrarModal(); 
            } catch (err) {
                alert('Error al guardar: ' + err.message);
            }
        };

        window.borrar = async (id) => { if(confirm('¬øBorrar?')) { await deleteDoc(doc(db, 'productos', id)); } };

        // CONSULTAS Y REPORTES
        window.buscarProducto = () => { const t=document.getElementById('buscador-global').value.toLowerCase(); const r=datos.filter(d=>d.nom.toLowerCase().includes(t)||d.cod.toLowerCase().includes(t)); const b=document.getElementById('tabla-consulta'); b.innerHTML=''; r.forEach(i=>{ b.innerHTML+=`<tr class="border-b border-slate-800"><td class="p-4 font-mono text-emerald-400">${i.cod}</td><td class="p-4 text-white">${i.nom}</td><td class="p-4 text-xs text-slate-500">${i.cat}</td><td class="p-4 text-center text-white">${i.cant}</td></tr>`; }); };
        window.generarOrden = () => { const f=datos.filter(d=>parseInt(d.cant)<parseInt(d.min)); if(!f.length)return alert('OK'); if(!ultimoResponsable){const n=prompt("Nombre:");if(n)ultimoResponsable=n;else return;} window.imprimirPDF('ORDEN', f, true); };
        window.generarReporteGeneral = () => { if(!datos.length)return alert('Vac√≠o'); window.imprimirPDF('GENERAL', datos); };
        window.generarReporteFaltantes = () => { const f=datos.filter(d=>parseInt(d.cant)<parseInt(d.min)); if(!f.length)return alert('OK'); window.imprimirPDF('FALTANTES', f); };
        window.imprimirPlan = () => { alert('Imprimiendo plan de trabajo...'); };
        window.imprimirPDF = (t,l,o=false) => {
            let h=`<html><head><title>${t}</title><style>body{font-family:sans-serif;padding:20px}table{width:100%;border-collapse:collapse}td,th{border:1px solid #ccc;padding:5px}</style></head><body><h1>${t}</h1><p>Fecha: ${new Date().toLocaleDateString()}</p><table><thead><tr><th>COD</th><th>DESC</th><th>CANT</th><th>ESTADO</th></tr></thead><tbody>`;
            l.forEach(x=>{ const d=x.min-x.cant; h+=`<tr><td>${x.cod}</td><td>${x.nom}</td><td>${x.cant}</td><td>${d>0?'FALTA '+d:'OK'}</td></tr>`; });
            h+='</tbody></table></body></html>'; const w=window.open(''); w.document.write(h); w.document.close();
        };

        // Mostrar login al cargar (cuando firebase termine de conectar, el loader desaparece)
        window.irA('vista-pass');
    </script>
</body>
</html>